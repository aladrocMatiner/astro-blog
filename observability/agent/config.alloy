discovery.docker "containers" {
	host = "unix:///var/run/docker.sock"
}

discovery.relabel "docker_labels" {
	targets = discovery.docker.containers.targets

	rule {
		action        = "replace"
		source_labels = ["__meta_docker_container_name"]
		regex         = "/(.*)"
		replacement   = "$1"
		target_label  = "container_name"
	}

	rule {
		action        = "replace"
		source_labels = ["__meta_docker_container_id"]
		target_label  = "container_id"
	}

	rule {
		action        = "replace"
		source_labels = ["__meta_docker_container_image"]
		target_label  = "image"
	}
}

loki.source.docker "containers" {
	host        = "unix:///var/run/docker.sock"
	targets     = discovery.relabel.docker_labels.output
	forward_to  = [loki.write.default.receiver]
	labels      = {job = "docker"}
}

loki.write "default" {
	endpoint {
		url = "http://loki:3100/loki/api/v1/push"
	}
	external_labels = {}
}
